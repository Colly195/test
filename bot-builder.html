<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Builder - RoyalTraders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --accent-green: #27ae60;
            --accent-red: #e74c3c;
            --accent-blue: #3498db;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --card-radius: 12px;
            --chart-bg: #ffffff;
            --chart-grid: #e0e0e0;
            --chart-line: #3498db;
            --chart-candle-up: #27ae60;
            --chart-candle-down: #e74c3c;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --accent-blue: #4fc3f7;
            --accent-green: #2ecc71;
            --accent-red: #ff6b6b;
            --chart-bg: #2d2d2d;
            --chart-grid: #495057;
            --chart-line: #4fc3f7;
            --chart-candle-up: #2ecc71;
            --chart-candle-down: #ff6b6b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        .hidden { display: none !important; }
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .logo-text { font-weight: 700; font-size: 1.2rem; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-run {
            background: var(--accent-green);
            color: white;
        }
        .btn-run:hover { background: #219a52; }
        .btn-secondary {
            background: var(--accent-blue);
            color: white;
        }
        .btn-secondary:hover { background: #2980b9; }
        .main-content {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .bot-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .bot-selector select {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 200px;
        }
        .bot-preview {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .bot-preview h3 { font-size: 1rem; margin: 0 0 0.5rem; }
        #previewChart { height: 200px; width: 100%; }
        .status-tag {
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-tag.running { background: var(--accent-green); color: white; }
        .status-tag.not-running { background: #ffc107; color: #212529; }
        .status-tag.connecting { background: var(--accent-blue); color: white; }
        .status-tag.error { background: var(--accent-red); color: white; }
        .main-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        .footer-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .footer-btn:hover { color: var(--accent-blue); }
        @media (max-width: 768px) {
            .top-header, .main-content, .main-footer { padding: 0.5rem; }
            .bot-selector { flex-direction: column; align-items: flex-start; }
            .bot-selector select { width: 100%; }
        }
    </style>
</head>
<body data-theme="light">
    <header class="top-header">
        <div class="header-left">
            <span class="logo-text">RoyalTraders</span>
        </div>
        <div class="header-right">
            <div id="user-display" class="user-info-container hidden" style="display: flex; align-items: center; gap: 0.5rem;">
                <div id="user-initials" style="background-color: #5c6bc0; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold;"></div>
                <span id="user-balance" style="font-weight: bold;">$0.00</span>
                <button id="logout-btn" class="btn btn-secondary">Log Out</button>
            </div>
            <div id="auth-links" class="auth-links-container">
                <button id="deriv-auth-btn" class="btn btn-secondary">Log in / Sign up with Deriv</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="bot-selector">
            <select id="bot-select">
                <option value="forex-scalping">Forex Scalping (EUR/USD, RSI)</option>
                <option value="volatility-dca">Volatility DCA (Volatility 100, DCA)</option>
                <option value="grid-trading">Grid Trading (GBP/JPY, Grid)</option>
            </select>
            <span id="statusTag" class="status-tag not-running">Not Running</span>
            <button id="runButton" class="btn btn-run"><i class="fa-solid fa-play"></i> Run Bot</button>
        </div>
        <div class="bot-preview">
            <h3>Bot Performance</h3>
            <p>Profit: <span id="realProfit">0.00</span> | Win Rate: <span id="winRate">0%</span> | Trades: <span id="tradeCount">0</span> | Commission: <span id="commissionEarned">0.00</span></p>
            <canvas id="previewChart"></canvas>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-left">
            <span id="dateTime">06:38 PM EAT, Tuesday, September 09, 2025</span>
        </div>
        <div class="footer-right">
            <button id="darkModeToggle" class="footer-btn" aria-label="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
        </div>
    </footer>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const APP_ID = '99973';
            const derivAuthBtn = document.getElementById('deriv-auth-btn');
            const userDisplay = document.getElementById('user-display');
            const authLinks = document.getElementById('auth-links');
            const logoutBtn = document.getElementById('logout-btn');
            const userInitials = document.getElementById('user-initials');
            const userBalance = document.getElementById('user-balance');
            const runButton = document.getElementById('runButton');
            const statusTag = document.getElementById('statusTag');
            const botSelect = document.getElementById('bot-select');
            const realProfit = document.getElementById('realProfit');
            const winRate = document.getElementById('winRate');
            const tradeCount = document.getElementById('tradeCount');
            const commissionEarned = document.getElementById('commissionEarned');
            let ws = null;
            let isRunning = false;
            let previewChart = null;
            let priceData = [];
            let profit = 0;
            let wins = 0;
            let totalTrades = 0;
            let totalCommission = 0;
            let currentContracts = [];

            // Predefined bot configurations
            const botConfigs = {
                'forex-scalping': {
                    name: 'Forex Scalping',
                    market: 'Forex',
                    symbol: 'frxEURUSD',
                    strategy: 'scalping',
                    stake: 10,
                    rsiPeriod: 14,
                    stopLoss: 2
                },
                'volatility-dca': {
                    name: 'Volatility DCA',
                    market: 'Derived',
                    symbol: 'R_100',
                    strategy: 'dca',
                    stake: 10,
                    interval: 5,
                    stopLoss: 2
                },
                'grid-trading': {
                    name: 'Grid Trading',
                    market: 'Forex',
                    symbol: 'frxGBPJPY',
                    strategy: 'grid',
                    stake: 10,
                    priceLevels: 1,
                    stopLoss: 2
                }
            };

            // Login handling
            if (derivAuthBtn) {
                derivAuthBtn.addEventListener('click', () => {
                    const oauthUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=en&brand=deriv`;
                    window.location.href = oauthUrl;
                });
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    sessionStorage.removeItem('deriv_token');
                    updateUIForLoginState(false);
                    window.location.reload();
                });
            }
            function updateUIForLoginState(isLoggedIn) {
                if (isLoggedIn) {
                    authLinks.classList.add('hidden');
                    userDisplay.classList.remove('hidden');
                    userInitials.textContent = 'RT';
                    fetchBalance();
                } else {
                    authLinks.classList.remove('hidden');
                    userDisplay.classList.add('hidden');
                    userBalance.textContent = '$0.00';
                }
            }
            function fetchBalance() {
                const token = sessionStorage.getItem('deriv_token');
                if (!token) return;
                const wsBalance = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
                wsBalance.onopen = () => {
                    wsBalance.send(JSON.stringify({ authorize: token }));
                };
                wsBalance.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    if (data.msg_type === 'authorize' && !data.error) {
                        wsBalance.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                    } else if (data.msg_type === 'balance') {
                        userBalance.textContent = `$${data.balance.balance.toFixed(2)}`;
                    } else if (data.error) {
                        console.error('Balance fetch error:', data.error.message);
                    }
                };
                wsBalance.onerror = () => wsBalance.close();
            }
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                sessionStorage.setItem('deriv_token', token);
                updateUIForLoginState(true);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                const storedToken = sessionStorage.getItem('deriv_token');
                updateUIForLoginState(!!storedToken);
            }

            // Date and time update
            function updateDateTime() {
                const now = new Date();
                document.getElementById('dateTime').textContent = now.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' });
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Theme toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', () => {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                darkModeToggle.querySelector('i').className = newTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                updateChartTheme(newTheme);
            });
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            darkModeToggle.querySelector('i').className = savedTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';

            // Chart initialization
            function initializeChart() {
                const ctx = document.getElementById('previewChart').getContext('2d');
                priceData = generateDefaultData();
                previewChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Price',
                            data: priceData,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-line'),
                            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-line').replace(')', ', 0.2)'),
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Bot Performance Chart',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 16 }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') },
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') }
                            },
                            y: {
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') },
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') }
                            }
                        }
                    }
                });
                updateChartTheme(savedTheme);
            }
            function generateDefaultData() {
                const now = Date.now();
                const defaultData = [];
                for (let i = 0; i < 10; i++) {
                    const time = now - (9 - i) * 60000;
                    const basePrice = 1000 + Math.random() * 100;
                    defaultData.push({ x: time, y: basePrice });
                }
                return defaultData;
            }
            function updateChartTheme(theme) {
                if (previewChart) {
                    previewChart.options.plugins.title.color = theme === 'dark' ? '#ffffff' : '#2c3e50';
                    previewChart.options.scales.x.grid.color = theme === 'dark' ? '#495057' : '#e0e0e0';
                    previewChart.options.scales.y.grid.color = theme === 'dark' ? '#495057' : '#e0e0e0';
                    previewChart.options.scales.x.ticks.color = theme === 'dark' ? '#adb5bd' : '#6c757d';
                    previewChart.options.scales.y.ticks.color = theme === 'dark' ? '#adb5bd' : '#6c757d';
                    previewChart.data.datasets[0].borderColor = theme === 'dark' ? '#4fc3f7' : '#3498db';
                    previewChart.data.datasets[0].backgroundColor = theme === 'dark' ? 'rgba(79, 195, 247, 0.2)' : 'rgba(52, 152, 219, 0.2)';
                    previewChart.update();
                }
            }
            function updateChart(price, time) {
                priceData.push({ x: time, y: parseFloat(price) });
                if (priceData.length > 100) priceData.shift();
                previewChart.data.datasets[0].data = priceData;
                previewChart.update('none');
            }

            // Bot running logic
            function startBot(botConfig) {
                const token = sessionStorage.getItem('deriv_token');
                if (!token) {
                    alert('Please log in to Deriv to run the bot.');
                    stopBot();
                    return;
                }
                const balance = parseFloat(userBalance.textContent.replace('$', '')) || 0;
                if (botConfig.stake > balance) {
                    alert('Insufficient balance for this stake.');
                    stopBot();
                    return;
                }
                if (ws) {
                    ws.close();
                    ws = null;
                }
                isRunning = true;
                statusTag.classList.remove('not-running', 'running', 'error');
                statusTag.classList.add('connecting');
                statusTag.textContent = 'Connecting...';
                runButton.innerHTML = '<i class="fa-solid fa-stop"></i> Stop Bot';
                priceData = [];
                previewChart.data.datasets[0].data = priceData;
                previewChart.update();
                currentContracts = [];

                ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
                ws.onopen = () => {
                    ws.send(JSON.stringify({ authorize: token }));
                };
                ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    if (data.msg_type === 'authorize') {
                        if (data.error) {
                            console.error('Authorization error:', data.error.message);
                            statusTag.classList.add('error');
                            statusTag.textContent = `Error: ${data.error.message}`;
                            stopBot();
                        } else {
                            ws.send(JSON.stringify({ ticks: botConfig.symbol, subscribe: 1 }));
                            statusTag.classList.remove('not-running', 'connecting', 'error');
                            statusTag.classList.add('running');
                            statusTag.textContent = 'Running';
                        }
                    } else if (data.msg_type === 'tick') {
                        const price = data.tick.quote;
                        const time = data.tick.epoch * 1000;
                        updateChart(price, time);
                        executeStrategy(botConfig, price, time);
                    } else if (data.msg_type === 'proposal') {
                        if (data.error) {
                            console.error('Proposal error:', data.error.message);
                        } else {
                            ws.send(JSON.stringify({ buy: 1, proposal_id: data.proposal.id, price: data.proposal.ask_price }));
                        }
                    } else if (data.msg_type === 'buy') {
                        if (data.error) {
                            console.error('Buy error:', data.error.message);
                            statusTag.classList.add('error');
                            statusTag.textContent = `Error: ${data.error.message}`;
                            stopBot();
                        } else {
                            currentContracts.push(data.buy.contract_id);
                            ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: data.buy.contract_id, subscribe: 1 }));
                        }
                    } else if (data.msg_type === 'proposal_open_contract') {
                        if (data.error) {
                            console.error('Contract update error:', data.error.message);
                        } else {
                            const contract = data.proposal_open_contract;
                            if (contract.is_sold) {
                                totalTrades++;
                                const contractProfit = contract.profit;
                                profit += contractProfit;
                                if (contractProfit > 0) wins++;
                                realProfit.textContent = profit.toFixed(2);
                                winRate.textContent = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) + '%' : '0%';
                                tradeCount.textContent = totalTrades;
                                const commission = (contract.payout * 0.03);
                                totalCommission += commission;
                                commissionEarned.textContent = totalCommission.toFixed(2);
                                currentContracts = currentContracts.filter(id => id !== contract.contract_id);
                            }
                        }
                    } else if (data.error) {
                        console.error('API error:', data.error.message);
                        statusTag.classList.add('error');
                        statusTag.textContent = `Error: ${data.error.message}`;
                        stopBot();
                    }
                };
                ws.onclose = () => {
                    if (isRunning) setTimeout(() => startBot(botConfig), 2000);
                };
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    statusTag.classList.add('error');
                    statusTag.textContent = 'Error: Connection failed';
                    stopBot();
                };
            }

            function stopBot() {
                if (ws) ws.close();
                isRunning = false;
                statusTag.classList.remove('connecting', 'running', 'error');
                statusTag.classList.add('not-running');
                statusTag.textContent = 'Not Running';
                runButton.innerHTML = '<i class="fa-solid fa-play"></i> Run Bot';
                priceData = generateDefaultData();
                previewChart.data.datasets[0].data = priceData;
                previewChart.update();
            }

            function executeStrategy(botConfig, price, time) {
                let tradeType = Math.random() > 0.5 ? 'CALL' : 'PUT';
                let shouldTrade = false;

                if (botConfig.strategy === 'dca') {
                    if (!botConfig.lastTradeTime || time - botConfig.lastTradeTime >= botConfig.interval * 60 * 1000) {
                        shouldTrade = true;
                        botConfig.lastTradeTime = time;
                        tradeType = 'CALL';
                    }
                } else if (botConfig.strategy === 'grid') {
                    shouldTrade = true;
                    tradeType = Math.random() > 0.5 ? 'CALL' : 'PUT';
                } else if (botConfig.strategy === 'scalping') {
                    const rsi = calculateRSI(priceData.map(d => d.y).slice(-botConfig.rsiPeriod));
                    if (rsi < 30) tradeType = 'CALL';
                    else if (rsi > 70) tradeType = 'PUT';
                    shouldTrade = rsi < 30 || rsi > 70;
                }

                if (shouldTrade && botConfig.stopLoss) {
                    const initialPrice = priceData[0].y;
                    if (Math.abs((price - initialPrice) / initialPrice * 100) > botConfig.stopLoss) {
                        alert('Stop loss triggered!');
                        stopBot();
                        return;
                    }
                }

                if (shouldTrade) {
                    requestTrade(botConfig.symbol, botConfig.stake, tradeType, price);
                }
            }

            function calculateRSI(prices) {
                if (prices.length < 2) return 50;
                let gains = 0, losses = 0;
                for (let i = 1; i < prices.length; i++) {
                    const diff = prices[i] - prices[i-1];
                    if (diff > 0) gains += diff;
                    else losses += Math.abs(diff);
                }
                const avgGain = gains / (prices.length - 1);
                const avgLoss = losses / (prices.length - 1);
                return avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
            }

            function requestTrade(symbol, stake, tradeType, price) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const proposal = {
                        proposal: 1,
                        amount: stake,
                        basis: 'stake',
                        contract_type: tradeType,
                        currency: 'USD',
                        symbol: symbol,
                        duration: 1,
                        duration_unit: 't'
                    };
                    ws.send(JSON.stringify(proposal));
                }
            }

            // Initialize chart and run button
            initializeChart();
            runButton.addEventListener('click', () => {
                if (isRunning) {
                    stopBot();
                } else {
                    const botConfig = botConfigs[botSelect.value];
                    startBot(botConfig);
                }
            });
        });
    </script>
