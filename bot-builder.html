<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Builder - RoyalTraders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --accent-green: #27ae60;
            --accent-red: #e74c3c;
            --accent-blue: #3498db;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --card-radius: 12px;
            --chart-bg: #ffffff;
            --chart-grid: #e0e0e0;
            --chart-line: #3498db;
            --chart-candle-up: #27ae60;
            --chart-candle-down: #e74c3c;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --accent-blue: #4fc3f7;
            --accent-green: #2ecc71;
            --accent-red: #ff6b6b;
            --chart-bg: #2d2d2d;
            --chart-grid: #495057;
            --chart-line: #4fc3f7;
            --chart-candle-up: #2ecc71;
            --chart-candle-down: #ff6b6b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        .hidden { display: none !important; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .card {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        .section { margin-bottom: 1.5rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; }
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .logo { width: 20px; height: 20px; }
        .logo-text { font-weight: 700; font-size: 1.1rem; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .main-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .nav-links-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            max-width: 100%;
            overflow-x: auto;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.8rem;
            text-decoration: none;
            color: var(--text-secondary);
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--accent-blue);
            color: white;
        }
        .nav-link i { margin-right: 0.4rem; font-size: 0.9rem; }
        .nav-right-actions { display: flex; align-items: center; gap: 0.5rem; }
        .status-tag {
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-tag.running { background: var(--accent-green); color: white; }
        .status-tag.not-running { background: #ffc107; color: #212529; }
        .status-tag.connecting { background: var(--accent-blue); color: white; }
        .status-tag.error { background: var(--accent-red); color: white; }
        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .btn-run {
            background: var(--accent-green);
            color: white;
            padding: 0.5rem 1rem;
        }
        .btn-run:hover { background: #219a52; }
        .btn-secondary { background: var(--accent-blue); color: white; }
        .btn-secondary:hover { background: #2980b9; }
        .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
        .btn-action {
            margin-right: 0.2rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-action:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        .main-content {
            padding: 1rem;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .warning-bar {
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .main-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        .footer-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .footer-btn:hover { color: var(--accent-blue); }
        .loading { opacity: 0.6; pointer-events: none; }
        /* Bot Builder Specific Styles */
        .bot-builder-main {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            padding: 0;
        }
        .bot-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .bot-builder-actions, .bot-builder-controls {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn, .control-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-btn:hover, .control-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        .bot-builder-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .block-workspace {
            flex: 1;
            overflow: auto;
            padding: 1rem;
            background: var(--bg-primary);
            min-height: 0;
        }
        .block-toolbar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
        }
        .block-group {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        .block-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border-color);
        }
        .block {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            gap: 0.5rem;
        }
        .block label {
            font-weight: 500;
            margin-right: 0.25rem;
        }
        .block input[type="text"], .block input[type="number"], .block select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            margin: 0 0.25rem;
            font-family: inherit;
            font-size: 0.9rem;
            min-width: 60px;
        }
        .block select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6" fill="%232c3e50"><path d="M5 6L0 0h10z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            padding-right: 1.5rem;
        }
        [data-theme="dark"] .block select {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6" fill="%23adb5bd"><path d="M5 6L0 0h10z"/></svg>');
        }
        .block select:focus, .block input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-blue);
            border-color: var(--accent-blue);
        }
        .block .fa-chevron-right, .block .fa-plus {
            font-size: 0.8rem;
            margin: 0 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .block .fa-plus:hover { color: var(--accent-green); }
        .block-group-1 .block, .block-group-run .block, .block-group-trade-options .block {
            background: #e3f2fd;
            border-color: var(--accent-blue);
        }
        [data-theme="dark"] .block-group-1 .block, [data-theme="dark"] .block-group-run .block, [data-theme="dark"] .block-group-trade-options .block {
            background: #0d47a1;
            color: white;
        }
        .block-group-3 .block, .block-group-4 .block {
            background: #fff8e1;
            border-color: #ffc107;
        }
        [data-theme="dark"] .block-group-3 .block, [data-theme="dark"] .block-group-4 .block {
            background: #ffca28;
            color: #212529;
        }
        .nested-block {
            margin-left: 1rem;
            background: #f5f5f5 !important;
            border-color: var(--accent-green);
        }
        [data-theme="dark"] .nested-block {
            background: #388e3c !important;
        }
        .trash-can {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: var(--accent-red);
            cursor: pointer;
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 50%;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            z-index: 5;
        }
        .trash-can:hover {
            transform: scale(1.1);
            background: var(--accent-red);
            color: white;
        }
        .bot-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .bot-preview h3 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
        }
        #previewChart { max-height: 200px; width: 100%; }
        .save-load-section {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .save-btn, .load-btn {
            background: var(--accent-green);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            border: none;
        }
        .load-btn { background: var(--accent-blue); }
        #botList {
            list-style: none;
            padding: 0;
        }
        #botList li {
            padding: 0.5rem;
            background: var(--bg-primary);
            margin-bottom: 0.25rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        #botList li:hover {
            background: var(--bg-secondary);
        }
        .delete-bot {
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1rem;
        }
        .delete-bot:hover { color: #c0392b; }
        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
            background: none;
            border: none;
        }
        .commission-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        @media (max-width: 768px) {
            .nav-links-container {
                display: none;
                flex-direction: column;
                width: 100%;
                background: var(--bg-primary);
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem;
                z-index: 10;
                border-top: 1px solid var(--border-color);
            }
            .nav-links-container.active { display: flex; }
            .hamburger { display: block; }
            .top-header, .main-content, .main-footer { padding: 0.5rem; }
            .section-title { font-size: 1.1rem; }
            .block { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
            .block input, .block select { width: 100%; min-width: auto; }
            .bot-builder-container { flex-direction: column; }
            .block-workspace { height: 60%; }
            .block-toolbar { width: 100%; height: 40%; }
            .bot-preview { font-size: 0.85rem; }
            .btn { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
            .btn-run { padding: 0.4rem 0.8rem; }
        }
        @media (max-width: 480px) {
            .logo-text { font-size: 1rem; }
            .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.75rem; }
            .bot-builder-actions, .bot-builder-controls { flex-wrap: wrap; }
        }
    </style>
</head>
<body data-theme="light">
    <header class="top-header">
        <div class="header-left">
            <svg class="logo" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM12 4.144L20 8.5L12 12.856L4 8.5L12 4.144ZM4 10.5L11 14.5V20.856L4 16.5V10.5ZM13 14.5L20 10.5V16.5L13 20.856V14.5Z"/>
            </svg>
            <span class="logo-text">RoyalTraders</span>
        </div>
        <div class="header-right">
            <div id="user-display" class="user-info-container hidden" style="display: flex; align-items: center; gap: 0.5rem;">
                <div id="user-initials" style="background-color: #5c6bc0; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold;"></div>
                <img id="country-flag" src="" alt="Country Flag" style="width: 25px; height: auto;">
                <span id="user-balance" style="font-weight: bold;"></span>
                <button id="logout-btn" class="btn btn-secondary btn-sm">Log Out</button>
            </div>
            <div id="auth-links" class="auth-links-container">
                <button id="deriv-auth-btn" class="btn btn-secondary">Log in / Sign up with Deriv</button>
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <button class="hamburger" aria-label="Toggle Menu"><i class="fa-solid fa-bars"></i></button>
        <div class="nav-links-container">
            <a href="index.html" class="nav-link" aria-label="Dashboard" data-page="index.html"><i class="fa-solid fa-home"></i><span>Dashboard</span></a>
            <a href="bot-builder.html" class="nav-link active" aria-label="Bot Builder" data-page="bot-builder.html"><i class="fa-solid fa-hammer"></i><span>Bot Builder</span></a>
            <a href="analysis-tool.html" class="nav-link" aria-label="Analysis Tool" data-page="analysis-tool.html"><i class="fa-solid fa-chart-line"></i><span>Analysis Tool</span></a>
            <a href="batch-trader.html" class="nav-link" aria-label="Batch Trader" data-page="batch-trader.html"><i class="fa-solid fa-layer-group"></i><span>Batch Trader</span></a>
            <a href="market-analyzer.html" class="nav-link" aria-label="Market Analyzer" data-page="market-analyzer.html"><i class="fa-solid fa-chart-area"></i><span>Market Analyzer</span></a>
            <a href="frequency-analysis.html" class="nav-link" aria-label="Frequency Analysis" data-page="frequency-analysis.html"><i class="fa-solid fa-calculator"></i><span>Frequency Analysis</span></a>
            <a href="digit-tool.html" class="nav-link" aria-label="Digit Tool" data-page="digit-tool.html"><i class="fa-solid fa-fingerprint"></i><span>Digit Tool</span></a>
            <a href="free-bots.html" class="nav-link" aria-label="Free Bots" data-page="free-bots.html"><i class="fa-solid fa-robot"></i><span>Free Bots</span></a>
            <a href="copy-trader.html" class="nav-link" aria-label="Copy Trader" data-page="copy-trader.html"><i class="fa-solid fa-copy"></i><span>Copy Trader</span></a>
            <a href="charts.html" class="nav-link" aria-label="Charts" data-page="charts.html"><i class="fa-solid fa-chart-bar"></i><span>Charts</span></a>
        </div>
        <div class="nav-right-actions">
            <span id="statusTag" class="status-tag not-running">Not Running</span>
            <button id="runButton" class="btn btn-run"><i class="fa-solid fa-play"></i><span id="runBtnText">Run Bot</span></button>
        </div>
    </nav>

    <main class="main-content bot-builder-main">
        <div class="bot-builder-header">
            <div class="bot-builder-actions">
                <button class="action-btn" title="New Bot"><i class="fas fa-file"></i></button>
                <button class="action-btn" title="Open Bot" id="loadBtn"><i class="fas fa-folder-open"></i></button>
                <button class="action-btn" title="Undo"><i class="fas fa-undo"></i></button>
                <button class="action-btn" title="Redo"><i class="fas fa-redo"></i></button>
                <button class="action-btn" title="Clear Workspace"><i class="fas fa-eraser"></i></button>
                <button class="action-btn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button class="action-btn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button class="action-btn save-btn" id="saveBtn" title="Save Bot"><i class="fas fa-save"></i></button>
                <select id="chart-type" class="action-btn" style="padding: 0.5rem;">
                    <option value="line">Line Chart</option>
                    <option value="candlestick">Candlestick Chart</option>
                </select>
            </div>
            <div class="bot-builder-controls">
                <button class="control-btn" id="playBtn" title="Play"><i class="fas fa-play"></i></button>
                <button class="control-btn" id="pauseBtn" title="Pause"><i class="fas fa-pause"></i></button>
                <button class="control-btn" id="stopBtn" title="Stop"><i class="fas fa-stop"></i></button>
            </div>
        </div>

        <div class="bot-builder-container">
            <div class="block-workspace" id="workspace" droppable="true">
                <div class="block-group block-group-1" id="tradeParams">
                    <div class="block-title">Trade Parameters</div>
                    <div class="block" draggable="true" data-type="market">
                        <label>Market: </label>
                        <select class="market-select">
                            <option>Derived</option>
                            <option>Forex</option>
                            <option>Stocks</option>
                            <option>Cryptocurrency</option>
                            <option>Commodities</option>
                        </select>
                        <select class="symbol-select">
                            <option value="R_100">Volatility 100 Index</option>
                            <option value="frxEURUSD">EUR/USD</option>
                            <option value="frxGBPJPY">GBP/JPY</option>
                            <option value="frxBTCUSD">BTC/USD</option>
                        </select>
                        <i class="fas fa-trash-alt delete-block"></i>
                    </div>
                    <div class="block" draggable="true" data-type="tradeType">
                        <label>Trade Type: </label>
                        <select>
                            <option value="CALL">Rise</option>
                            <option value="PUT">Fall</option>
                            <option value="DIGITMATCH">Digits Match</option>
                            <option value="HIGHER">Higher</option>
                            <option value="LOWER">Lower</option>
                        </select>
                        <i class="fas fa-plus add-nested"></i>
                        <i class="fas fa-trash-alt delete-block"></i>
                    </div>
                    <div class="block" draggable="true" data-type="stake">
                        <label>Stake: </label>
                        <input type="number" value="10" min="0.35">
                        <i class="fas fa-trash-alt delete-block"></i>
                    </div>
                </div>
                <div class="bot-preview">
                    <h3>Bot Preview</h3>
                    <p>Simulated Performance: <span id="simProfit">0</span> | Win Rate: <span id="winRate">0%</span> | Commission Earned: <span id="commissionEarned">0</span></p>
                    <p class="commission-note">Note: A 3% commission is applied to each trade's potential payout, supporting RoyalTraders' development.</p>
                    <canvas id="previewChart"></canvas>
                </div>
            </div>

            <div class="block-toolbar">
                <div class="save-load-section">
                    <button class="save-btn" id="saveToList">Save to List</button>
                    <button class="load-btn" id="loadFromList">Load from List</button>
                </div>
                <ul id="botList"></ul>
                <div class="block-group block-group-3">
                    <div class="block-title">Available Blocks</div>
                    <div class="block" draggable="true" data-type="condition">
                        <label>If </label>
                        <select>
                            <option value="rsi_overbought">RSI > 70</option>
                            <option value="ma_crossover">MA Crossover</option>
                            <option value="last_digit">Last Digit == 5</option>
                            <option value="price_ema">Price > EMA</option>
                        </select>
                        <i class="fas fa-plus add-nested"></i>
                    </div>
                    <div class="block" draggable="true" data-type="action">
                        <label>Action: </label>
                        <select><option>Buy</option><option>Sell</option></select>
                        <input type="number" placeholder="Stake" value="10" min="0.35">
                    </div>
                    <div class="block" draggable="true" data-type="martingale">
                        <label>Martingale Factor: </label>
                        <input type="number" value="2" min="1">
                    </div>
                    <div class="block" draggable="true" data-type="stopLoss">
                        <label>Stop Loss: </label>
                        <input type="number" placeholder="100" min="0">
                    </div>
                </div>
            </div>

            <div class="trash-can" id="trashCan"><i class="fas fa-trash-alt"></i></div>
        </div>
    </main>

    <div class="warning-bar">
        <strong>Disclaimer:</strong> Trading involves risk. All analysis tools and bots are for informational purposes only. A 3% commission is applied to trade payouts.
    </div>

    <footer class="main-footer">
        <div class="footer-left">
            <span id="dateTime"></span>
        </div>
        <div class="footer-right">
            <button id="settingsToggle" class="footer-btn" aria-label="Settings"><i class="fa-solid fa-cog"></i></button>
            <button id="darkModeToggle" class="footer-btn" aria-label="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
            <div class="language-select" style="display: flex; align-items: center;">
                <button class="footer-btn" aria-label="Select language"><i class="fa-solid fa-globe"></i></button>
                <i class="fa-solid fa-caret-down" style="margin-left: 0.25rem; color: var(--text-secondary);"></i>
            </div>
        </div>
    </footer>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const APP_ID = '99626';
            const derivAuthBtn = document.getElementById('deriv-auth-btn');
            const userDisplay = document.getElementById('user-display');
            const authLinks = document.getElementById('auth-links');
            const logoutBtn = document.getElementById('logout-btn');
            const userInitials = document.getElementById('user-initials');
            const userBalance = document.getElementById('user-balance');

            if (derivAuthBtn) {
                derivAuthBtn.addEventListener('click', () => {
                    const oauthUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=en&brand=deriv`;
                    window.location.href = oauthUrl;
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    sessionStorage.removeItem('deriv_token');
                    updateUIForLoginState(false);
                    window.location.reload();
                });
            }

            function updateUIForLoginState(isLoggedIn) {
                if (isLoggedIn) {
                    authLinks.classList.add('hidden');
                    userDisplay.classList.remove('hidden');
                    userInitials.textContent = 'RT';
                    fetchBalance();
                } else {
                    authLinks.classList.remove('hidden');
                    userDisplay.classList.add('hidden');
                    userBalance.textContent = '$0.00';
                }
            }

            function fetchBalance() {
                const token = sessionStorage.getItem('deriv_token');
                if (!token) return;
                const wsBalance = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
                wsBalance.onopen = () => {
                    wsBalance.send(JSON.stringify({ authorize: token }));
                };
                wsBalance.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    if (data.msg_type === 'authorize' && !data.error) {
                        wsBalance.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                    } else if (data.msg_type === 'balance') {
                        userBalance.textContent = `$${data.balance.balance.toFixed(2)}`;
                    } else if (data.error) {
                        console.error('Balance fetch error:', data.error.message);
                    }
                };
                wsBalance.onerror = () => wsBalance.close();
            }

            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                sessionStorage.setItem('deriv_token', token);
                updateUIForLoginState(true);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                const storedToken = sessionStorage.getItem('deriv_token');
                updateUIForLoginState(!!storedToken);
            }

            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links-container');
            if (hamburger) {
                hamburger.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                    const icon = hamburger.querySelector('i');
                    icon.classList.toggle('fa-bars');
                    icon.classList.toggle('fa-times');
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentPage = window.location.pathname.split('/').pop() || 'bot-builder.html';
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === currentPage);
            });

            function updateDateTime() {
                const now = new Date();
                document.getElementById('dateTime').textContent = now.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' });
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);

            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', () => {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                darkModeToggle.querySelector('i').className = newTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                updateChartTheme(newTheme);
            });
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            darkModeToggle.querySelector('i').className = savedTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';

            document.getElementById('settingsToggle').addEventListener('click', () => {
                alert('Settings modal would open here.');
            });

            const APP_ID = '99626';
            let ws = null;
            let botWorkspace = document.getElementById('workspace');
            let trashCan = document.getElementById('trashCan');
            let botBlocks = [];
            let previewChart = null;
            let isDragging = false;
            let isRunning = false;
            let priceData = [];
            let profit = 0;
            let wins = 0;
            let totalTrades = 0;
            let totalCommission = 0;
            const statusTag = document.getElementById('statusTag');
            const runButton = document.getElementById('runButton');
            const runBtnText = document.getElementById('runBtnText');
            const chartTypeSelect = document.getElementById('chart-type');
            const commissionEarned = document.getElementById('commissionEarned');
            let currentChartType = chartTypeSelect.value;

            let savedBots = JSON.parse(localStorage.getItem('savedBots')) || [
                { name: 'Scalping King', config: { market: 'Derived', symbol: 'R_100', tradeType: 'CALL', stake: 10, conditions: [{type: 'rsi_overbought', action: 'Sell'}] } },
                { name: 'Trend Follower', config: { market: 'Forex', symbol: 'frxEURUSD', tradeType: 'DIGITMATCH', stake: 5, conditions: [{type: 'ma_crossover', action: 'Buy'}] } },
                { name: 'EMA Cross', config: { market: 'Cryptocurrency', symbol: 'frxBTCUSD', tradeType: 'HIGHER', stake: 20, conditions: [{type: 'price_ema', action: 'Buy'}] } }
            ];

            function renderBotList() {
                const botList = document.getElementById('botList');
                botList.innerHTML = '';
                savedBots.forEach((bot, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${bot.name}</span><span class="delete-bot" data-index="${index}" title="Delete">&times;</span>`;
                    li.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-bot')) loadBot(bot.config);
                    });
                    botList.appendChild(li);
                });
            }
            renderBotList();

            document.getElementById('botList').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-bot')) {
                    const index = parseInt(e.target.dataset.index);
                    if (confirm(`Delete ${savedBots[index].name}?`)) {
                        savedBots.splice(index, 1);
                        localStorage.setItem('savedBots', JSON.stringify(savedBots));
                        renderBotList();
                    }
                }
            });

            function generateDefaultData() {
                const now = Date.now();
                const defaultData = [];
                for (let i = 0; i < 10; i++) {
                    const time = now - (9 - i) * 6000;
                    const basePrice = 1000 + Math.random() * 100;
                    if (currentChartType === 'candlestick') {
                        defaultData.push({
                            x: time,
                            open: basePrice,
                            high: basePrice + Math.random() * 10,
                            low: basePrice - Math.random() * 10,
                            close: basePrice + (Math.random() - 0.5) * 10
                        });
                    } else {
                        defaultData.push({ x: time, y: basePrice });
                    }
                }
                return defaultData;
            }

            function updateChartTheme(theme) {
                if (previewChart) {
                    previewChart.options.plugins.title.color = theme === 'dark' ? '#ffffff' : '#2c3e50';
                    previewChart.options.scales.x.grid.color = theme === 'dark' ? '#495057' : '#e0e0e0';
                    previewChart.options.scales.y.grid.color = theme === 'dark' ? '#495057' : '#e0e0e0';
                    previewChart.options.scales.x.ticks.color = theme === 'dark' ? '#adb5bd' : '#6c757d';
                    previewChart.options.scales.y.ticks.color = theme === 'dark' ? '#adb5bd' : '#6c757d';
                    if (currentChartType === 'line') {
                        previewChart.data.datasets[0].borderColor = theme === 'dark' ? '#4fc3f7' : '#3498db';
                        previewChart.data.datasets[0].backgroundColor = theme === 'dark' ? 'rgba(79, 195, 247, 0.2)' : 'rgba(52, 152, 219, 0.2)';
                    } else {
                        previewChart.data.datasets[0].color = theme === 'dark' ? '#ffffff' : '#2c3e50';
                        previewChart.data.datasets[0].barBackgroundColor = {
                            up: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-up'),
                            down: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-down'),
                            unchanged: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-up')
                        };
                    }
                    previewChart.update();
                }
            }

            function initializeChart() {
                const ctx = document.getElementById('previewChart').getContext('2d');
                priceData = generateDefaultData();
                previewChart = new Chart(ctx, {
                    type: currentChartType === 'candlestick' ? 'candlestick' : 'line',
                    data: {
                        datasets: [{
                            label: 'Price',
                            data: priceData,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-line'),
                            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-line').replace(')', ', 0.2)'),
                            borderWidth: currentChartType === 'candlestick' ? 1 : 2,
                            fill: currentChartType === 'candlestick' ? false : false,
                            pointRadius: currentChartType === 'candlestick' ? 0 : 0,
                            tension: currentChartType === 'candlestick' ? 0 : 0.1,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                            barBackgroundColor: currentChartType === 'candlestick' ? {
                                up: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-up'),
                                down: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-down'),
                                unchanged: getComputedStyle(document.documentElement).getPropertyValue('--chart-candle-up')
                            } : undefined
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Bot Preview Chart',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                font: { size: 16 }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'second',
                                    displayFormats: { second: 'HH:mm:ss' }
                                },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') },
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') }
                            },
                            y: {
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') },
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') }
                            }
                        }
                    }
                });
                updateChartTheme(savedTheme);
            }

            function updateChart(price, time) {
                if (currentChartType === 'candlestick') {
                    const lastCandle = priceData[priceData.length - 1];
                    const parsedPrice = parseFloat(price);
                    if (lastCandle && time - lastCandle.x < 60000) {
                        lastCandle.close = parsedPrice;
                        lastCandle.high = Math.max(lastCandle.high, parsedPrice);
                        lastCandle.low = Math.min(lastCandle.low, parsedPrice);
                    } else {
                        priceData.push({
                            x: time,
                            open: lastCandle ? lastCandle.close : parsedPrice,
                            high: parsedPrice,
                            low: parsedPrice,
                            close: parsedPrice
                        });
                    }
                } else {
                    priceData.push({ x: time, y: parseFloat(price) });
                }
                if (priceData.length > 100) priceData.shift();
                previewChart.data.datasets[0].data = priceData;
                previewChart.update('none');
            }

            function startBot(symbol) {
                const token = sessionStorage.getItem('deriv_token');
                if (!token) {
                    alert('Please log in to Deriv to run the bot.');
                    stopBot();
                    return;
                }
                if (ws) {
                    ws.close();
                    ws = null;
                }
                isRunning = true;
                statusTag.classList.remove('not-running', 'running', 'error');
                statusTag.classList.add('connecting');
                statusTag.textContent = 'Connecting...';
                runBtnText.textContent = 'Stop Bot';
                runButton.innerHTML = '<i class="fa-solid fa-stop"></i>Stop Bot';
                priceData = [];
                previewChart.data.datasets[0].data = priceData;
                previewChart.update();

                try {
                    ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
                    ws.onopen = () => {
                        console.log(`Bot: WebSocket connected for ${symbol}`);
                        ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
                        ws.send(JSON.stringify({ authorize: token }));
                        statusTag.classList.remove('not-running', 'connecting', 'error');
                        statusTag.classList.add('running');
                        statusTag.textContent = 'Running';
                    };
                    ws.onmessage = (msg) => {
                        try {
                            const data = JSON.parse(msg.data);
                            if (data.msg_type === 'authorize') {
                                if (data.error) {
                                    console.error('Authorization error:', data.error.message);
                                    statusTag.classList.add('error');
                                    statusTag.textContent = `Error: ${data.error.message}`;
                                    stopBot();
                                }
                            } else if (data.msg_type === 'tick') {
                                const price = data.tick.quote;
                                const time = data.tick.epoch * 1000;
                                updateChart(price, time);
                                evaluateBotConditions(symbol, price, time);
                            } else if (data.msg_type === 'proposal') {
                                if (data.error) {
                                    console.error('Proposal error:', data.error.message);
                                } else {
                                    executeTrade(data.proposal);
                                }
                            } else if (data.msg_type === 'buy') {
                                if (data.error) {
                                    console.error('Buy error:', data.error.message);
                                    statusTag.classList.add('error');
                                    statusTag.textContent = `Error: ${data.error.message}`;
                                    stopBot();
                                } else {
                                    console.log('Trade placed:', data.buy);
                                    trackCommission(data.buy);
                                }
                            } else if (data.error) {
                                console.error('API error:', data.error.message);
                                statusTag.classList.add('error');
                                statusTag.textContent = `Error: ${data.error.message}`;
                                stopBot();
                            }
                        } catch (error) {
                            console.error('Message parsing error:', error);
                            statusTag.classList.add('error');
                            statusTag.textContent = 'Error: Failed to process data';
                            stopBot();
                        }
                    };
                    ws.onclose = () => {
                        console.log('Bot: WebSocket closed');
                        if (isRunning) {
                            console.log('Bot: Attempting to reconnect...');
                            setTimeout(() => startBot(symbol), 2000);
                        } else {
                            statusTag.classList.remove('connecting', 'running', 'error');
                            statusTag.classList.add('not-running');
                            statusTag.textContent = 'Not Running';
                            runBtnText.textContent = 'Run Bot';
                            runButton.innerHTML = '<i class="fa-solid fa-play"></i>Run Bot';
                            priceData = generateDefaultData();
                            previewChart.data.datasets[0].data = priceData;
                            previewChart.update();
                        }
                    };
                    ws.onerror = (error) => {
                        console.error('Bot: WebSocket error:', error);
                        statusTag.classList.add('error');
                        statusTag.textContent = 'Error: Connection failed';
                        stopBot();
                    };
                } catch (error) {
                    console.error('Bot: Failed to start:', error);
                    statusTag.classList.add('error');
                    statusTag.textContent = 'Error: Failed to initialize';
                    stopBot();
                }
            }

            function stopBot() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
                isRunning = false;
                statusTag.classList.remove('connecting', 'running', 'error');
                statusTag.classList.add('not-running');
                statusTag.textContent = 'Not Running';
                runBtnText.textContent = 'Run Bot';
                runButton.innerHTML = '<i class="fa-solid fa-play"></i>Run Bot';
                priceData = generateDefaultData();
                previewChart.data.datasets[0].data = priceData;
                previewChart.update();
            }

            function evaluateBotConditions(symbol, price, time) {
                const marketBlock = botBlocks.find(b => b.type === 'market');
                const tradeTypeBlock = botBlocks.find(b => b.type === 'tradeType');
                const stakeBlock = botBlocks.find(b => b.type === 'stake');
                const conditionBlocks = botBlocks.filter(b => b.type === 'condition');
                const actionBlocks = botBlocks.filter(b => b.type === 'action');
                const stopLossBlock = botBlocks.find(b => b.type === 'stopLoss');

                if (!marketBlock || !tradeTypeBlock || !stakeBlock) {
                    alert('Please configure market, trade type, and stake.');
                    stopBot();
                    return;
                }

                const stake = parseFloat(stakeBlock.element.querySelector('input').value);
                const tradeType = tradeTypeBlock.element.querySelector('select').value;
                const stopLoss = stopLossBlock ? parseFloat(stopLossBlock.element.querySelector('input').value) : Infinity;

                if (profit <= -stopLoss) {
                    alert('Stop loss reached!');
                    stopBot();
                    return;
                }

                let shouldTrade = false;
                conditionBlocks.forEach(block => {
                    const condition = block.element.querySelector('select').value;
                    if (condition === 'rsi_overbought') {
                        shouldTrade = price > 1000; // Simplified RSI simulation
                    } else if (condition === 'ma_crossover') {
                        shouldTrade = price > 1000 + Math.random() * 10; // Simplified MA simulation
                    }
                });

                if (shouldTrade || conditionBlocks.length === 0) {
                    const action = actionBlocks.length > 0 ? actionBlocks[0].element.querySelector('select').value : 'Buy';
                    requestTradeProposal(symbol, tradeType, stake, action);
                }
            }

            function requestTradeProposal(symbol, tradeType, stake, action) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const proposal = {
                        proposal: 1,
                        amount: stake,
                        basis: 'stake',
                        contract_type: tradeType,
                        currency: 'USD',
                        symbol: symbol,
                        duration: 1,
                        duration_unit: 't',
                        barrier: tradeType.includes('HIGHER') || tradeType.includes('LOWER') ? '1000' : undefined,
                        commission: 0.03 // 3% markup commission
                    };
                    ws.send(JSON.stringify(proposal));
                }
            }

            function executeTrade(proposal) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const buy = {
                        buy: proposal.id,
                        price: proposal.ask_price
                    };
                    ws.send(JSON.stringify(buy));
                    totalTrades++;
                    const win = Math.random() > 0.4; // Simulate trade outcome for testing
                    profit += win ? proposal.payout - proposal.ask_price : -proposal.ask_price;
                    document.getElementById('simProfit').textContent = profit.toFixed(2);
                    document.getElementById('winRate').textContent = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) + '%' : '0%';
                    if (win) wins++;
                }
            }

            function trackCommission(buyData) {
                const commission = buyData.commission || 0;
                totalCommission += commission;
                commissionEarned.textContent = totalCommission.toFixed(2);
            }

            document.querySelectorAll('[draggable="true"]').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    e.dataTransfer.setData('text/plain', block.dataset.type);
                    block.classList.add('dragging');
                });
                block.addEventListener('dragend', () => {
                    block.classList.remove('dragging');
                    isDragging = false;
                });
            });

            botWorkspace.addEventListener('dragover', (e) => e.preventDefault());
            botWorkspace.addEventListener('drop', (e) => {
                e.preventDefault();
                if (isDragging) {
                    const type = e.dataTransfer.getData('text/plain');
                    const newBlock = createBlock(type);
                    botWorkspace.querySelector('#tradeParams').appendChild(newBlock);
                    botBlocks.push({ type, element: newBlock });
                    updatePreview();
                }
            });

            trashCan.addEventListener('dragover', (e) => e.preventDefault());
            trashCan.addEventListener('drop', (e) => {
                e.preventDefault();
                if (isDragging) {
                    const dragged = document.querySelector('.dragging');
                    if (dragged) {
                        dragged.remove();
                        botBlocks = botBlocks.filter(b => b.element !== dragged);
                        updatePreview();
                    }
                }
            });

            botWorkspace.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-nested')) {
                    const parent = e.target.closest('.block');
                    const nested = document.createElement('div');
                    nested.className = 'block nested-block';
                    nested.innerHTML = '<label>Nested Action: </label><select><option>Buy</option><option>Sell</option></select><input type="number" placeholder="Stake" min="0.35"><i class="fas fa-trash-alt delete-nested"></i>';
                    parent.appendChild(nested);
                }
                if (e.target.classList.contains('delete-nested')) {
                    e.target.closest('.nested-block').remove();
                    updatePreview();
                }
                if (e.target.classList.contains('delete-block')) {
                    const block = e.target.closest('.block');
                    block.remove();
                    botBlocks = botBlocks.filter(b => b.element !== block);
                    updatePreview();
                }
            });

            function createBlock(type) {
                const block = document.createElement('div');
                block.className = 'block';
                block.draggable = true;
                block.dataset.type = type;
                switch (type) {
                    case 'market':
                        block.innerHTML = '<label>Market: </label><select class="market-select"><option>Derived</option><option>Forex</option><option>Stocks</option></select><select class="symbol-select"><option value="R_100">Volatility 100 Index</option><option value="frxEURUSD">EUR/USD</option></select><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    case 'tradeType':
                        block.innerHTML = '<label>Trade Type: </label><select><option value="CALL">Rise</option><option value="PUT">Fall</option><option value="DIGITMATCH">Digits Match</option></select><i class="fas fa-plus add-nested"></i><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    case 'condition':
                        block.innerHTML = '<label>If </label><select><option value="rsi_overbought">RSI > 70</option><option value="ma_crossover">Price > MA</option><option value="last_digit">Last Digit == 5</option></select><i class="fas fa-plus add-nested"></i><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    case 'action':
                        block.innerHTML = '<label>Action: </label><select><option>Buy</option><option>Sell</option></select><input type="number" placeholder="Stake" value="10" min="0.35"><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    case 'martingale':
                        block.innerHTML = '<label>Martingale: </label><input type="number" value="2" min="1"><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    case 'stopLoss':
                        block.innerHTML = '<label>Stop Loss: </label><input type="number" placeholder="100" min="0"><i class="fas fa-trash-alt delete-block"></i>';
                        break;
                    default:
                        block.innerHTML = '<label>Custom Block</label><input type="text" placeholder="Details"><i class="fas fa-trash-alt delete-block"></i>';
                }
                return block;
            }

            document.getElementById('saveToList').addEventListener('click', () => {
                const botName = prompt('Bot Name:');
                if (botName) {
                    const botConfig = {
                        name: botName,
                        blocks: botBlocks.map(b => ({ type: b.type, content: b.element.outerHTML })),
                        market: document.querySelector('.market-select')?.value || 'Derived',
                        symbol: document.querySelector('.symbol-select')?.value || 'R_100'
                    };
                    savedBots.push(botConfig);
                    localStorage.setItem('savedBots', JSON.stringify(savedBots));
                    renderBotList();
                    alert('Bot saved!');
                }
            });

            document.getElementById('loadFromList').addEventListener('click', () => {
                alert('Select a bot from the list below.');
            });

            function loadBot(config) {
                botWorkspace.innerHTML = '<div class="block-group block-group-1" id="tradeParams"><div class="block-title">Trade Parameters</div></div><div class="bot-preview"><h3>Bot Preview</h3><p>Simulated Performance: <span id="simProfit">0</span> | Win Rate: <span id="winRate">0%</span> | Commission Earned: <span id="commissionEarned">0</span></p><p class="commission-note">Note: A 3% commission is applied to each trade\'s potential payout, supporting RoyalTraders\' development.</p><canvas id="previewChart"></canvas></div>';
                botBlocks = [];
                config.blocks?.forEach(blockData => {
                    const temp = document.createElement('div');
                    temp.innerHTML = blockData.content;
                    const block = temp.firstChild;
                    block.draggable = true;
                    block.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-block')) block.remove();
                    });
                    botWorkspace.querySelector('#tradeParams').appendChild(block);
                    botBlocks.push({ type: blockData.type, element: block });
                });
                document.querySelector('.market-select').value = config.market;
                document.querySelector('.symbol-select').value = config.symbol;
                initializeChart();
                updatePreview();
                alert('Bot loaded!');
            }

            runButton.addEventListener('click', () => {
                if (isRunning) {
                    stopBot();
                } else {
                    const marketBlock = botBlocks.find(b => b.type === 'market');
                    if (!marketBlock) {
                        alert('Please add a market block to run the bot.');
                        return;
                    }
                    const symbol = marketBlock.element.querySelector('.symbol-select').value;
                    startBot(symbol);
                }
            });

            document.getElementById('playBtn').addEventListener('click', () => {
                const marketBlock = botBlocks.find(b => b.type === 'market');
                if (!marketBlock) {
                    alert('Please add a market block to run the bot.');
                    return;
                }
                const symbol = marketBlock.element.querySelector('.symbol-select').value;
                startBot(symbol);
            });

            document.getElementById('pauseBtn').addEventListener('click', () => {
                if (isRunning) {
                    statusTag.classList.remove('running');
                    statusTag.classList.add('not-running');
                    statusTag.textContent = 'Paused';
                }
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                stopBot();
            });

            document.querySelector('.action-btn[title="Clear Workspace"]').addEventListener('click', () => {
                if (confirm('Clear all blocks?')) {
                    botWorkspace.innerHTML = '<div class="block-group block-group-1" id="tradeParams"><div class="block-title">Trade Parameters</div></div><div class="bot-preview"><h3>Bot Preview</h3><p>Simulated Performance: <span id="simProfit">0</span> | Win Rate: <span id="winRate">0%</span> | Commission Earned: <span id="commissionEarned">0</span></p><p class="commission-note">Note: A 3% commission is applied to each trade\'s potential payout, supporting RoyalTraders\' development.</p><canvas id="previewChart"></canvas></div>';
                    botBlocks = [];
                    initializeChart();
                    updatePreview();
                }
            });

            document.querySelector('.action-btn[title="New Bot"]').addEventListener('click', () => {
                if (confirm('Start new bot?')) {
                    document.querySelector('.action-btn[title="Clear Workspace"]').click();
                }
            });

            chartTypeSelect.addEventListener('change', () => {
                currentChartType = chartTypeSelect.value;
                previewChart.destroy();
                initializeChart();
                if (isRunning) {
                    const marketBlock = botBlocks.find(b => b.type === 'market');
                    if (marketBlock) startBot(marketBlock.element.querySelector('.symbol-select').value);
                }
            });

            function updatePreview() {
                const totalStake = botBlocks.reduce((sum, b) => {
                    const input = b.element.querySelector('input[type="number"]');
                    return sum + (parseFloat(input?.value) || 0);
                }, 0);
                console.log(`Total Stake: ${totalStake}`);
            }

            initializeChart();
        });
    </script>
</body>
</html>